{% extends "base.html" %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gestao_servicos.css') }}">
{% endblock %}

{% block conteudo %}
<div class="container mx-auto px-0 sm:px-4 pb-12">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-black text-navy-900 tracking-tight">Gestão de Serviços</h2>
            <p class="text-sm text-gray-500">Controle de produção, entrega e financeiro.</p>
        </div>
        
        <div class="flex gap-2">
            <a href="{{ url_for('vendas.nova_venda') }}" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-50 transition-colors text-sm flex items-center shadow-sm">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Nova Venda
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8">
        {% if current_user.tem_permissao('vendas_ver_valores') %}
        <div class="lg:col-span-2 grid grid-cols-2 gap-4">
            <div class="bg-navy-900 text-white p-5 rounded-2xl shadow-lg relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="dollar-sign" class="w-16 h-16"></i></div>
                <p class="text-xs font-bold uppercase tracking-wider opacity-70">A Receber (Geral)</p>
                <h3 class="text-2xl font-black mt-1 format-money" data-value="{{ kpi_receber }}">--</h3>
            </div>
            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 text-green-100 group-hover:scale-110 transition-transform"><i data-lucide="trending-up" class="w-16 h-16"></i></div>
                <p class="text-xs font-bold uppercase text-gray-400">Recebido (Mês)</p>
                <h3 class="text-2xl font-black mt-1 text-green-600 format-money" data-value="{{ kpi_recebido_mes }}">--</h3>
            </div>
        </div>
        {% endif %}

        {% if current_user.tem_permissao('vendas_ver_metricas') %}
        <div class="lg:col-span-2 bg-white p-2 rounded-2xl border border-gray-100 shadow-sm grid grid-cols-4 gap-1">
            <div class="flex flex-col items-center justify-center p-2 rounded-xl bg-gray-50">
                <span class="text-2xl font-bold text-gray-700">{{ qtd_pendente }}</span>
                <span class="text-[10px] uppercase font-bold text-gray-400">Fila</span>
            </div>
            <div class="flex flex-col items-center justify-center p-2 rounded-xl bg-blue-50">
                <span class="text-2xl font-bold text-blue-600">{{ qtd_producao }}</span>
                <span class="text-[10px] uppercase font-bold text-blue-400">Produção</span>
            </div>
            <div class="flex flex-col items-center justify-center p-2 rounded-xl bg-yellow-50">
                <span class="text-2xl font-bold text-yellow-600">{{ qtd_pronto }}</span>
                <span class="text-[10px] uppercase font-bold text-yellow-400">Pronto</span>
            </div>
            <div class="flex flex-col items-center justify-center p-2 rounded-xl bg-green-50">
                <span class="text-2xl font-bold text-green-600">{{ qtd_entregues_mes|default(0) }}</span>
                <span class="text-[10px] uppercase font-bold text-green-400">Entregues</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-center">
        <div class="flex-1 w-full relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
            <input type="text" id="filtroTexto" value="{{ filtros.q }}" 
                   placeholder="Buscar por ID, Cliente, CPF ou Serviço..." 
                   class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-navy-900 outline-none transition-all">
        </div>
        
        <div class="flex gap-2 w-full md:w-auto overflow-x-auto">
            <select id="filtroStatus" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 font-medium cursor-pointer hover:border-navy-900 focus:outline-none">
                <option value="">Status: Todos</option>
                <option value="pendente" {{ 'selected' if filtros.status == 'pendente' }}>Pendente</option>
                <option value="producao" {{ 'selected' if filtros.status == 'producao' }}>Produção</option>
                <option value="pronto" {{ 'selected' if filtros.status == 'pronto' }}>Pronto</option>
                <option value="entregue" {{ 'selected' if filtros.status == 'entregue' }}>Entregue</option>
            </select>

            <select id="filtroVendedor" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 font-medium cursor-pointer hover:border-navy-900 focus:outline-none">
                <option value="">Vendedor: Todos</option>
                {% for v in vendedores %}
                <option value="{{ v }}" {{ 'selected' if filtros.vendedor == v }}>{{ v }}</option>
                {% endfor %}
            </select>

            <input type="date" id="filtroData" value="{{ filtros.data }}" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 cursor-pointer">
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-100 text-xs uppercase text-gray-400 font-bold tracking-wider">
                        <th class="px-6 py-4">Serviço / Cliente</th>
                        <th class="px-6 py-4">Detalhes</th>
                        <th class="px-6 py-4 text-center">Status</th>
                        <th class="px-6 py-4 text-right pr-12">Financeiro</th>
                        <th class="px-6 py-4 text-right w-48">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    {% for s in servicos %}
                    <tr class="table-row-hover animate-entry group">
                        
                        <td class="px-6 py-4 align-top">
                            <div class="flex items-start gap-3">
                                <div class="bg-navy-50 text-navy-900 font-black text-xs px-2 py-1 rounded border border-navy-100">
                                    #{{ s.id }}
                                </div>
                                <div>
                                    <p class="font-bold text-navy-900 text-sm leading-tight">{{ s.cliente_nome }}</p>
                                    <div class="flex items-center text-xs text-gray-400 mt-1">
                                        <i data-lucide="user" class="w-3 h-3 mr-1"></i> {{ s.vendedor.nome }}
                                        <span class="mx-1">•</span>
                                        {{ s.criado_em.strftime('%d/%m') }}
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 align-top">
                            {% if s.modo == 'multipla' %}
                                <div class="flex items-center text-blue-600 bg-blue-50 px-2 py-1 rounded w-fit">
                                    <i data-lucide="layers" class="w-3 h-3 mr-1.5"></i>
                                    <span class="text-xs font-bold">{{ s.itens|length }} Itens Diversos</span>
                                </div>
                            {% else %}
                                <p class="text-sm font-medium text-gray-700">
                                    {{ s.produto.nome if s.produto else 'Serviço Personalizado' }}
                                </p>
                                <p class="text-xs text-gray-500 mt-0.5">
                                    {{ s.cor.nome if s.cor else 'Sem acabamento' }} • {{ s.quantidade_pecas }} un
                                </p>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 align-top text-center">
                            {% if s.status == 'pendente' %}
                                <span class="badge-status badge-pendente">Fila de Espera</span>
                            {% elif s.status == 'producao' %}
                                <span class="badge-status badge-producao animate-pulse"><i data-lucide="hammer" class="w-3 h-3 mr-1"></i> Produzindo</span>
                            {% elif s.status == 'pronto' %}
                                <span class="badge-status badge-pronto">Aguardando Retirada</span>
                            {% elif s.status == 'entregue' %}
                                <span class="badge-status badge-entregue">Finalizado</span>
                            {% elif s.status == 'cancelado' %}
                                <span class="badge-status badge-cancelado">Cancelado</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 align-top text-right pr-12">
                            {% if current_user.tem_permissao('vendas_ver_valores') %}
                                <p class="font-bold text-navy-900 format-money" data-value="{{ s.valor_final }}">--</p>
                                
                                {% if s.valor_restante > 0.01 %}
                                    <div class="flex justify-end mt-1">
                                        <span class="text-xs font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded flex items-center">
                                            Falta: <span class="format-money ml-1" data-value="{{ s.valor_restante }}">--</span>
                                        </span>
                                    </div>
                                {% else %}
                                    <p class="text-xs font-bold text-green-600 flex items-center justify-end mt-1">
                                        <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i> Pago
                                    </p>
                                {% endif %}
                            {% else %}
                                <span class="text-xs text-gray-300">---</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 align-top text-right w-48">
                            {% set historico = { 
                                'criado_em': s.criado_em.strftime('%Y-%m-%d %H:%M'), 
                                'vendedor': s.vendedor.nome,
                                'data_producao': s.data_inicio_producao.strftime('%Y-%m-%d %H:%M') if s.data_inicio_producao else None,
                                'data_pronto': s.data_pronto.strftime('%Y-%m-%d %H:%M') if s.data_pronto else None,
                                'data_entrega': s.data_entrega.strftime('%Y-%m-%d %H:%M') if s.data_entrega else None,
                                'data_cancelamento': s.data_cancelamento.strftime('%Y-%m-%d %H:%M') if s.data_cancelamento else None,
                                'motivo_cancelamento': s.motivo_cancelamento
                            } %}
                            
                            <button class="btn-abrir-modal group relative inline-flex items-center justify-center p-2 rounded-lg bg-white border border-gray-200 hover:bg-navy-900 hover:border-navy-900 hover:text-white transition-all shadow-sm"
                                data-id="{{ s.id }}"
                                data-cliente="{{ s.cliente_nome }}"
                                data-contato="{{ s.cliente_contato }}"
                                data-descricao="{{ s.descricao_servico }}"
                                data-restante="{{ s.valor_restante }}"
                                data-status="{{ s.status }}"
                                data-modo="{{ s.modo }}"
                                data-historico="{{ historico|tojson|forceescape }}">
                                
                                <span class="max-w-0 overflow-hidden whitespace-nowrap opacity-0 transition-all duration-300 ease-out group-hover:max-w-[80px] group-hover:opacity-100 group-hover:mr-2 text-xs font-bold">
                                    Gerenciar
                                </span>
                                <i data-lucide="settings-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex items-center justify-between">
            <span class="text-xs text-gray-500 font-bold uppercase">
                Página {{ paginacao.page }} de {{ paginacao.pages }}
            </span>
            <div class="flex gap-2">
                {% if paginacao.has_prev %}
                    <a href="{{ url_for('vendas.listar_vendas', page=paginacao.prev_num) }}" class="px-3 py-1 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600 hover:bg-gray-100">Anterior</a>
                {% endif %}
                {% if paginacao.has_next %}
                    <a href="{{ url_for('vendas.listar_vendas', page=paginacao.next_num) }}" class="px-3 py-1 bg-navy-900 text-white rounded text-xs font-bold hover:bg-navy-700">Próxima</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="modalServico" class="fixed inset-0 z-50 hidden">
        <div id="modalOverlay" class="absolute inset-0 bg-navy-900/60 backdrop-blur-sm transition-opacity cursor-pointer"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
            
            <div class="bg-navy-900 px-6 py-5 flex justify-between items-start shrink-0">
                <div>
                    <h3 class="text-white font-bold text-lg" id="modalTitulo">Carregando...</h3>
                    <div class="flex items-center text-blue-200 text-sm mt-1">
                        <i data-lucide="user" class="w-3 h-3 mr-1"></i> <span id="modalVendedor">--</span>
                        <span class="mx-2 opacity-50">|</span>
                        <i data-lucide="calendar" class="w-3 h-3 mr-1"></i> <span id="modalDataVenda">--</span>
                    </div>
                </div>
                <button id="btnFecharModal" class="text-white/70 hover:text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="flex border-b border-gray-100 bg-gray-50 px-4">
                <button class="tab-btn active px-6 py-4 text-sm font-bold text-navy-900 border-b-2 border-navy-900 transition-colors flex items-center hover:bg-gray-100" data-target="tab-servico">
                    <i data-lucide="layers" class="w-4 h-4 mr-2 text-electric-500"></i>
                    Detalhes & Produção
                </button>
                {% if current_user.tem_permissao('vendas_ver_valores') %}
                <button class="tab-btn px-6 py-4 text-sm font-medium text-gray-500 hover:text-navy-700 transition-colors flex items-center hover:bg-gray-100 border-b-2 border-transparent hover:border-gray-300" data-target="tab-financeiro">
                    <i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>
                    Financeiro & Baixa
                </button>
                {% endif %}
            </div>

            <div class="flex-1 overflow-hidden relative bg-white">
                <div id="tab-servico" class="tab-content active h-full overflow-y-auto custom-scrollbar p-6 space-y-6">
                    <div class="flex items-center justify-between bg-blue-50 px-4 py-3 rounded-xl border border-blue-100 shadow-sm">
                        <div class="flex items-center text-blue-900">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3"><i data-lucide="phone" class="w-4 h-4 text-blue-600"></i></div>
                            <div><span class="text-xs text-blue-500 font-bold uppercase block">Contato</span><span class="text-sm font-bold" id="modalContato">--</span></div>
                        </div>
                        <a id="btnWhatsapp" href="#" target="_blank" class="hidden text-xs bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex items-center transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5"><i data-lucide="message-circle" class="w-4 h-4 mr-1.5"></i> WhatsApp</a>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Descrição do Pedido</h4>
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 text-navy-900 text-sm leading-relaxed font-medium" id="modalDescricao">--</div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Linha do Tempo</h4>
                        <div class="timeline-container" id="timelineContainer"></div>
                    </div>
                    <div id="divStatusActions" class="pt-4 border-t border-gray-100">
                        <div id="botoesStatus" class="flex flex-col gap-3"></div>
                        <div class="mt-6 text-center">
                            <button id="btnShowCancelar" class="text-xs text-red-400 hover:text-red-600 font-medium hover:underline flex items-center justify-center w-full transition-colors"><i data-lucide="x-circle" class="w-3 h-3 mr-1"></i> Cancelar e Estornar Serviço</button>
                        </div>
                    </div>
                    <div id="areaCancelamento" class="hidden bg-red-50 p-5 rounded-xl border border-red-200 animate-fade-in">
                        <h4 class="text-sm font-bold text-red-800 mb-2 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Confirmar Cancelamento</h4>
                        <form method="POST" id="formCancelar">
                            <label class="block text-xs text-red-700 font-bold mb-1">Motivo do cancelamento (Obrigatório)</label>
                            <textarea name="motivo_cancelamento" rows="2" class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none text-sm bg-white" required minlength="5"></textarea>
                            <div class="flex gap-3 mt-3">
                                <button type="button" id="btnAbortarCancelamento" class="flex-1 py-2 border border-gray-300 bg-white text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-50">Voltar</button>
                                <button type="submit" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-bold shadow-md">Confirmar Cancelamento</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                {% if current_user.tem_permissao('vendas_ver_valores') %}
                <div id="tab-financeiro" class="tab-content h-full overflow-y-auto custom-scrollbar p-6 hidden space-y-6">
                    <div class="text-center mb-6">
                        <p class="text-sm text-gray-500 font-medium">Valor Restante a Pagar</p>
                        <h3 class="text-4xl font-black text-navy-900 mt-1">R$ <span id="modalRestanteDisplay">0.00</span></h3>
                    </div>
                    <div id="areaPagamento" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <h4 class="text-sm font-bold text-navy-900 mb-4 flex items-center">
                            <div class="w-6 h-6 rounded bg-green-100 text-green-600 flex items-center justify-center mr-2"><i data-lucide="dollar-sign" class="w-3 h-3"></i></div> Registrar Recebimento
                        </h4>
                        <form method="POST" id="formPagamento" class="space-y-4">
                            {{ form_pgto.hidden_tag() }}
                            <div class="grid grid-cols-2 gap-4">
                                {% for subfield in form_pgto.tipo_recebimento %}
                                <label class="flex items-center justify-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-navy-500 hover:bg-navy-50 transition-all group">
                                    {{ subfield(class="text-navy-900 focus:ring-navy-900 peer") }}
                                    <span class="ml-2 text-sm font-bold text-gray-700 peer-checked:text-navy-900">{{ subfield.label.text }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <div id="divValorInput">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor (R$)</label>
                                {{ form_pgto.valor(class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy-900 outline-none text-lg font-bold text-navy-900", placeholder="0,00") }}
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data do Pagamento</label>
                                {{ form_pgto.data_pagamento(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-navy-900 outline-none text-gray-600") }}
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center justify-center"><i data-lucide="check" class="w-5 h-5 mr-2"></i> Confirmar Pagamento</button>
                        </form>
                    </div>
                    <div id="msgPago" class="hidden flex flex-col items-center justify-center py-10 bg-green-50 rounded-xl border border-green-100">
                        <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-3 shadow-sm"><i data-lucide="check-circle-2" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-green-800">Totalmente Pago!</h3>
                        <p class="text-green-600 text-sm">Nenhuma pendência financeira.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/gestao_servicos.js') }}"></script>
{% endblock %}